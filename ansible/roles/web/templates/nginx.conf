# {{ ansible_managed }}

upstream radar_api {
  server 127.0.0.1:5000;
}

server {
  listen 80;
  server_name localhost;
  server_name {{ inventory_hostname }};
  return 301 https://{{ inventory_hostname }}$request_uri;
}

server {
  listen 443;
  server_name {{ inventory_hostname }};

  root /opt/radar-client;
  index index.html;

  ssl on;
  ssl_certificate /etc/pki/tls/certs/{{ inventory_hostname }}.crt;
  ssl_certificate_key /etc/pki/tls/private/{{ inventory_hostname }}.key;

  add_header Strict-Transport-Security "max-age=31536000";
  add_header X-Frame-Options "SAMEORIGIN";

  gzip on;
  gzip_disable "msie6";
  gzip_http_version 1.1;
  gzip_comp_level 5;
  gzip_min_length 256;
  gzip_proxied any;
  gzip_vary on;

  gzip_types
    text/css
    application/json
    application/javascript;

  client_max_body_size 100M;

  location / {
  }

  location /index.html {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires 0;
  }

  location /api {
    rewrite ^/api/?(.*) /$1 break;
    uwsgi_pass radar_api;
    include /etc/nginx/uwsgi_params;
  }
}
