upstream radar_api {
  server 127.0.0.1:5000;
}

upstream radar_dev_api {
  server 127.0.0.1:5001;
}

server {
  listen 8080;
  server_name localhost;

  root /var/www/radar;
  index index.html;

  # https://docs.vagrantup.com/v2/synced-folders/virtualbox.html
  sendfile off;

  gzip on;
  gzip_disable "msie6";
  gzip_http_version 1.1;
  gzip_comp_level 5;
  gzip_min_length 256;
  gzip_proxied any;
  gzip_vary on;

  gzip_types
    text/css
    application/json
    application/javascript;

  location / {
  }

  location /index.html {
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires 0;
  }

  location /api {
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;

    rewrite ^/api/?(.*) /$1 break;

    proxy_pass http://radar_api;
  }
}

server {
  listen 8081;
  server_name localhost;

  root /home/radar/src/client;
  index index.html;

  # https://docs.vagrantup.com/v2/synced-folders/virtualbox.html
  sendfile off;

  gzip on;
  gzip_disable "msie6";
  gzip_http_version 1.1;
  gzip_comp_level 5;
  gzip_min_length 256;
  gzip_proxied any;
  gzip_vary on;

  gzip_types
    text/css
    application/json
    application/javascript;

  add_header Cache-Control "no-cache, no-store, must-revalidate";
  add_header Pragma "no-cache";
  add_header Expires 0;

  location / {
    try_files /.tmp/serve/$uri /src/$uri /index.html;
  }

  location /bower_components {
  }

  location /index.html {
    root /home/radar/src/client/.tmp/serve;
  }

  location /api {
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;

    rewrite ^/api/?(.*) /$1 break;
    
    proxy_pass http://radar_dev_api;
  }
}
